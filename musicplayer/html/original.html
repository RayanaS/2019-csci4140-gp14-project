<script type="text/javascript" src="../js/sidebar.js"></script>

<script language="JavaScript" type="text/javascript" src="../node_modules/p5/lib/p5.js"></script>
<script type="text/javascript" src="../node_modules/p5/lib/addons/p5.sound.js"></script>

<style>
.song {
    background: white;
    border-radius: 13px;
    width: 400px;
}

.song h2 {
    padding: 0.5em 0.8em;
    text-align: center;
}

.button {
    background-color: transparent;
    border: none;
    display: inline;
    margin: 1em 1em;
}

.myslider {
    -webkit-appearance: none;
    height: 6px;
    border-radius: 4px;
    background: #f5f5f5;
    display: inline;
    -webkit-transition: .2s;
    transition: background .2s;
}
.myslider:hover {
    background: #4abbfc;
}

.myslider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 15px;
    height: 15px;
    border-radius: 7px;
    background: #454545;
    box-shadow: 1px 2px 3px rgba(0,0,0,0.5);
}

.songName:hover{
    text-decoration: underline;
}

</style>

<div>
    <!-- <h1 style="padding: 0.3em 1em;">Song Player</h1> -->

    <div style="text-align:left;">
        <input type="text" placeholder="Please select a file" id="actual-file" disabled="disabled"/>
        <input type="button" value="Upload new music" id="select-file"/>
    </div>
    <br>
    <p>Or paste YouTube link here: </p> 
    <input type="text" placeholder="youtube.com" id="ytlink"/>
    <input type="button" value="Download" id="ytdl" onclick="youtubedl(document.getElementById('ytlink').value);"/>
    <p id="ytnull" style="color: red;"></p>

    <hr>
    <h5>- Uploaded Songs - (sorted by alphabet)</h5>
    <div id="music_list" style="width: 400px; height: 100px; overflow-y: scroll;"></div>

    <hr>

    <div class="song">
      <h2 id="songName">Please select a song</h2>
        <input type="range" class="myslider" min="0" max="100" value="0" id="progress" style="width: 80%; margin: 1em 2.5em 1em 2.5em;">
        <div>
          <button class="button" onclick="togglePlaying();">
              <img id="img" src="../image/player/play.png" style="height: 40px; width: auto; margin: 0.5em 1em 0.5em 1.5em" alt="Play/Pause"/>
          </button>
          <img src="../image/player/volume.png" style="height: 25px; width: auto; margin-right: 10px">
          <input type="range" class="myslider" min="0" max="100" value="100" id="volume" style="width: 20%">
      </div>
    </div>
</div>

<script>
    const { webContents } = require('electron');
    const { ipcRenderer } = require('electron');
    var song, noise, reverb, cVerb;

    var volume = document.getElementById("volume");
    var icon = document.getElementById("img");
    var progress = document.getElementById("progress");
    var play = "../image/player/play.png";
    var pause = "../image/player/pause.png";

    var length;

    function preload(filepath) {
        song = loadSound(filepath, loaded);
    }

    function loaded() {
        length = song.duration();
    }

    function setup() {
        reverb = new p5.Reverb();
        song.disconnect();
    }

    function togglePlaying() {
        if (!song.isPlaying()) {
            song.play();
            icon.src = pause;
        } else {
            song.pause();
            icon.src = play;
        }
    }

    volume.oninput = function () {
        song.setVolume(this.value / 100);
        noise.setVolume(this.value / 100);
    };

    var intrvl = setInterval( function(){
        if (song.isPlaying()) {
            progress.value = (song.currentTime() / length) * 100;
        }
    }, 1000);    

    var app = require('electron').remote; 
    var dialog = app.dialog;
    var fs = require('fs');
                
    document.getElementById('select-file').addEventListener('click',function(){
        dialog.showOpenDialog(function (fileNames) {
            console.log(fileNames);
            if(fileNames === undefined){
                console.log("No file selected");
            }else{
                document.getElementById("actual-file").value = fileNames[0];
                music_path = fileNames[0];
                readFile(music_path);
                // preload(music_path.value);
                

                var music_name = music_path.toString().substring(music_path.toString().lastIndexOf('/')+1);

                fs.copyFile(music_path.toString(), 'audio/user_upload/'+music_name, (err) => {
                    if (err) throw err;
                    console.log('music was copied to destination');
                });
                app.getCurrentWindow().reload();
            }
        }); 
    },false);

    var music_path = document.getElementById('songName').innerHTML;

    function readFile(filepath) {
        fs.readFile(filepath, 'utf-8', function (err, data) {
            if(err){
                alert("An error ocurred reading the file :" + err.message);
                return;
            }
        });
    }

    function playSong(song_id){
        song.disconnect();
        icon.src = play;
        progress.value = 0;
        preload("../audio/user_upload/" + song_id);
        document.getElementById('songName').innerHTML = song_id;  
    }

    var intrvl = setInterval( function(){
        if (song.isPlaying()) {
            progress.value = (song.currentTime() / length) * 100;
        }
    }, 1000);

    const dirPath = 'audio/user_upload';
    const music_list = fs.readdirSync(dirPath);

    // for(var i=0; i < music_list.length; i++){
    //     console.log(music_list[i]);
    // }

    var nHTML = '';

    if(music_list.length == 1){
        document.getElementById("music_list").innerHTML = "<p>File empty...</p>";
    }
    else{
        music_list.forEach(function(item) {
            if(item != ".DS_Store")
                nHTML += '<li><p class="songName" id="' + item + '" onClick=playSong(this.id) style="padding:0; margin:0; line-height:14px;">' + item + '</a></li>';
        });
        document.getElementById("music_list").innerHTML = '<ul>' + nHTML + '</ul>';
    }

    function youtubedownload(ytcode){
        var Downloader = require("../js/downloader");
        var dl = new Downloader();
        var i = 0;

        dl.getMP3({videoId: ytcode}, function(err,res){
            i++;
            if(err)
                throw err;
            else{
                console.log("Song "+ i + " was downloaded: " + res.file);
            }
            app.getCurrentWindow().reload();
        });
        
    }

    var ytlink;
    var ytcode = "test";
    function youtubedl(ytlink){
        if(ytlink == ""){
            document.getElementById("ytnull").innerHTML = "YouTube link should not be null.";
        }
        else{
            document.getElementById("ytnull").innerHTML = "";
            ytcode = ytlink.substring(ytlink.lastIndexOf('=')+1);
            youtubedownload(ytcode);
        }
        
    }


</script>

<script type="text/javascript" src="../js/sidebar2.js"></script>