<script type="text/javascript" src="../js/sidebar.js"></script>

<script language="JavaScript" type="text/javascript" src="../node_modules/p5/lib/p5.js"></script>
<script type="text/javascript" src="../node_modules/p5/lib/addons/p5.sound.js"></script>

<style>
.song {
    background: white;
    border-radius: 13px;
    width: 500px;
}

.song h2 {
    padding: 0.5em 0.8em;
    text-align: center;
}

.button {
    background-color: transparent;
    border: none;
    display: inline;
}

.myslider {
    -webkit-appearance: none;
    height: 6px;
    border-radius: 4px;
    background: #eeeeee;
    display: inline;
    -webkit-transition: .2s;
    transition: background .2s;
}
.myslider:hover {
    background: #82d3fc;
}

.myslider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 15px;
    height: 15px;
    border-radius: 7px;
    background: #454545;
    box-shadow: 1px 2px 3px rgba(0,0,0,0.5);
}

.noise img {
    height: 50px;
    width: auto;
    margin: 1.5em 1.5em 1em 1.5em;
    opacity: 0.4;
    -webkit-transition: .2s;
    transition: opacity .2s;
}

.noise img:hover {
    opacity: 1;
}

.songName:hover{
    text-decoration: underline;
}
</style>

<div>
    <!-- <h1 style="padding: 0.3em 1em;">Combined Player</h1> -->

    <!--
    <div style="text-align:left;">
            <input type="text" placeholder="Please select a file" id="actual-file" disabled="disabled"/>
            <input type="button" value="Upload new music" id="select-file"/>
        </div>
        <br>
        <p>Or paste YouTube link here: </p>
        <input type="text" placeholder="youtube.com" id="ytlink"/>
        <input type="button" value="Download" id="ytdl" onclick="youtubedl(document.getElementById('ytlink').value);"/>
        <p id="ytnull" style="color: red;"></p>
        <p id="ytloading" style="color: rgb(28, 28, 94);"></p>

        <hr>
        -->

    <h5>- Uploaded Songs - (sorted by alphabet)</h5>
    <div id="music_list" style="margin: 1em; width: 400px; height: 100px; overflow-y: scroll;"></div>

    <hr>

    <div class="song">
            <h2 id="songName">Please select a song</h2>
        <input type="range" class="myslider" min="0" max="100" value="0" id="progress" style="width: 80%; margin: 1em 2.5em 1em 2.5em;">
        <div>

          <button class="button" onclick="togglePlaying();">
              <img id="img" src="../image/player/play.png" style="height: 40px; width: auto; margin: 1em 1.5em 1em 1.5em" alt="Play/Pause"/>
          </button>
          <img src="../image/player/volume.png" style="height: 25px; width: auto; margin-right: 10px">
          <input type="range" class="myslider" min="0" max="100" value="100" id="volume" style="width: 20%">
        </div>
    </div>

    <div class = "noise">
        <button class="button" onclick="loadCafe();">
            <img src="../image/cafe.png">
        </button>
        <img src="../image/campfire.png">
        <button class="button" onclick="loadRain();">
            <img src="../image/rain.png">
        </button>
        <button class="button">
            <img src="../image/library.png">
        </button>
        <img src="../image/wine.png">
        <button class="button" onclick="loadConcert();">
            <img src="../image/concert.png">
        </button>
    </div>

</div>

<script>
    const { ipcRenderer } = require('electron');
    var reverb, cVerb, length;
    var curSongKey = '', curNoiseKey = 'cafe';
    var volume = document.getElementById("volume");
    var icon = document.getElementById("img");
    var progress = document.getElementById("progress");
    var imgSet = document.getElementsByClassName("noise")[0].getElementsByTagName("img");

    var play = "../image/player/play.png";
    var pause = "../image/player/pause.png";
    var volumeWeight = 1;

    var songObject = [], noiseObject = [], noisePath = [], noiseIndex = [];
    noisePath["cafe"] = "../audio/env/cafe(louder).mp3";
    noisePath["campfire"] = "../audio/env/campfire.mp3";
    noisePath["rain"] = "../audio/white_noise/rain.mp3";
    noisePath["library"] = "../audio/env/library.mp3";
    noisePath["bar"] = "../audio/white_noise/train.mp3";
    noisePath["concert"] = "../audio/env/concert.mp3";

    noiseIndex["cafe"] = 0;
    noiseIndex["campfire"] = 1;
    noiseIndex["rain"] = 2;
    noiseIndex["library"] = 3;
    noiseIndex["bar"] = 4;
    noiseIndex["concert"] = 5;

    /*

        LOADING AND ADJUSTMENT SECTION

     */

    function setup() {
        for (var key in noisePath) {
            noiseObject[key] = loadSound(noisePath[key]);
        }
        reverb = new p5.Reverb();
        cVerb = new p5.Convolver("../IMreverbs/Narrow Bumpy Space.wav");
    }

    function playSong(songID){
        if (songObject[curSongKey] !== undefined) {
            songObject[curSongKey].stop();
        }

        // CHANGE THE CURRENT PLAYING SONG KEY
        curSongKey = songID;
        songObject[curSongKey] = loadSound("../audio/user_upload/" + songID, loaded);
        songObject[curSongKey].playMode('restart');

        loadCafe();

        noiseObject[curNoiseKey].pause();
        icon.src = play;
        progress.value = 0;
        document.getElementById('songName').innerHTML = songID;
    }

    function loaded() {
        length = songObject[curSongKey].duration();
        progress.max = length;
    }

    function togglePlaying() {
        if (songObject[curSongKey] !== undefined) {
            if (songObject[curSongKey].isPlaying() || noiseObject[curNoiseKey].isPlaying()) {
                songObject[curSongKey].pause();
                icon.src = play;
                noiseObject[curNoiseKey].pause();
            } else {
                songObject[curSongKey].play();
                icon.src = pause;
                noiseObject[curNoiseKey].play();
            }
        }
    }

    volume.oninput = function () {
        songObject[curSongKey].setVolume(this.value / 100);
        noiseObject[curNoiseKey].setVolume((this.value / 100) * volumeWeight);
    };

    progress.oninput = function () {
        songObject[curSongKey].stop();
        songObject[curSongKey].play(2, 1, 1, 200, length - 200);
        console.log(this.value);
        console.log(length - this.value);
    };

    var intrvl = setInterval( function(){
        if (songObject[curSongKey].isPlaying()) {
            progress.value = songObject[curSongKey].currentTime();
            console.log(songObject[curSongKey].currentTime());
        }
    }, 2000);  // clearInterval(intrvl); // if it's needed

    /*

        ATMOSPHERE STIMULATOR SECTION

    function loadLibrary() {
        /*

        NOT YET TUNED

    wnoise.disconnect();
    wnoise = loadSound("../audio/env/library.mp3", loadNoise);
    wnoise.setVolume(0.5);
    volumeWeight = 0.5;
    }


    */

    function loadCafe() {
        songObject[curSongKey].disconnect();
        reverb.process(songObject[curSongKey], 7, 48);

        imgSet[noiseIndex[curNoiseKey]].style.opacity = "0.3";
        if (noiseObject[curNoiseKey].isPlaying()) {
            // curNoiseKey: ORIGINAL KEY
            noiseObject[curNoiseKey].stop();
            curNoiseKey = "cafe";
            noiseObject[curNoiseKey].play();
        } else {
            noiseObject[curNoiseKey].stop();
            curNoiseKey = "cafe";
        }
        imgSet[noiseIndex[curNoiseKey]].style.opacity = "1";

        volumeWeight = 1;
    }

    function loadRain() {
        songObject[curSongKey].disconnect();
        reverb.process(songObject[curSongKey], 3, 40);

        imgSet[noiseIndex[curNoiseKey]].style.opacity = "0.3";
        if (noiseObject[curNoiseKey].isPlaying()) {
            noiseObject[curNoiseKey].stop();
            curNoiseKey = "rain";
            noiseObject[curNoiseKey].play();
        } else {
            noiseObject[curNoiseKey].stop();
            curNoiseKey = "rain";
        }
        imgSet[noiseIndex[curNoiseKey]].style.opacity = "1";

        noiseObject[curNoiseKey].setVolume(0.5);
        volumeWeight = 0.5;
    }

    function loadConcert() {
        songObject[curSongKey].disconnect();
        cVerb.process(songObject[curSongKey]);

        imgSet[noiseIndex[curNoiseKey]].style.opacity = "0.3";
        if (noiseObject[curNoiseKey].isPlaying()) {
            noiseObject[curNoiseKey].stop();
            curNoiseKey = "concert";
            noiseObject[curNoiseKey].play();
        } else {
            noiseObject[curNoiseKey].stop();
            curNoiseKey = "concert";
        }
        imgSet[noiseIndex[curNoiseKey]].style.opacity = "1";

        noiseObject[curNoiseKey].setVolume(0.55);
        volumeWeight = 0.55;
    }

    /*

        DISPLAY SONG LIST SECTION

     */

    var fs = require('fs');
    const dirPath = 'audio/user_upload';
    const music_list = fs.readdirSync(dirPath);
    var nHTML = '';

    if(music_list.length === 1) {
        document.getElementById("music_list").innerHTML = "<p>File empty...</p>";
    } else {
        music_list.forEach(function(item) {
            if(item !== ".DS_Store") {
                nHTML += '<li><p class="songName" id="' + item +
                    '" onClick = playSong(this.id) style="padding:0; margin:0; line-height:12px;">'
                    + item + '</a></li>';
            }
        });
        document.getElementById("music_list").innerHTML = '<ul>' + nHTML + '</ul>';
    }


    /*

        YOUTUBE UPLOAD

    */

    /*
    function youtubedownload(ytcode){
        var Downloader = require("../js/downloader");
        var dl = new Downloader();
        var i = 0;

        dl.getMP3({videoId: ytcode}, function(err,res){
            i++;
            if(err)
                throw err;
            else{
                console.log("Song "+ i + " was downloaded: " + res.file);
            }
            app.getCurrentWindow().reload();
        });
        
    }

    var ytlink;
    var ytcode = "test";
    function youtubedl(ytlink){
        if(ytlink === ""){
            document.getElementById("ytnull").innerHTML = "YouTube link should not be null.";
            document.getElementById("ytloading").innerHTML = "";
        }
        else{
            document.getElementById("ytnull").innerHTML = "";
            document.getElementById("ytloading").innerHTML = "Downloading... Page will refresh once the song is successfully downloaded.";
            ytcode = ytlink.substring(ytlink.lastIndexOf('=')+1);
            youtubedownload(ytcode);
        }
        
    }
    */

</script>

<script type="text/javascript" src="../js/sidebar2.js"></script>